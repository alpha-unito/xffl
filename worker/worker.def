Bootstrap: docker
From: {{ BASE_IMAGE }}

%arguments
	WORKDIR=$(pwd)
    REQUIREMENTS_FILE=requirements.txt
	REQUIREMENTS_FOLDER=requirements
	LIBRARIES=libraries
	LLAMA_RECIPES=llama-recipes
	# NVIDIA
	BASE_IMAGE=nvcr.io/nvidia/pytorch:24.09-py3
	# ROCM
	#BASE_IMAGE=rocm/pytorch:rocm5.7_ubuntu22.04_py3.10_pytorch_2.0.1

%setup
    mkdir ${APPTAINER_ROOTFS}/{{ REQUIREMENTS_FOLDER }}

%files
	#{{ WORKDIR }}/{{ REQUIREMENTS_FILE }} /{{ REQUIREMENTS_FOLDER }}/
	{{ WORKDIR }}/../{{ LIBRARIES }}/{{ LLAMA_RECIPES }} /{{ REQUIREMENTS_FOLDER }}/

%post
	# System update
	apt-get update -y && \
	apt-get upgrade -y && \
	apt-get autoremove -y && \
	apt-get clean
	# Basic Python requirements installation
	#cd /{{ REQUIREMENTS_FOLDER }}/ && \
	#python3 -m pip install --no-cache-dir --upgrade pip && \
	#python3 -m pip install --no-cache-dir -r {{ REQUIREMENTS_FILE }} && \
	#rm -rf {{ REQUIREMENTS_FILE }}
	
	# Worker
	# llama-recipes installation
	cd /{{ REQUIREMENTS_FOLDER }}/{{ LLAMA_RECIPES }} && \
	python3 -m pip install --no-cache-dir .
	# latest transformers installation
	#git clone --depth 1 https://github.com/huggingface/transformers.git && \
	#cd transformers && \
	#python3 -m pip install --no-cache-dir tiktoken blobfile && \
	#python3 -m pip install --no-cache-dir . 
	
	# ROCM
	# Bits&Bytes ROCM compilation
	#cd /{{ REQUIREMENTS_FOLDER }}/ && \
	#python3 -m pip uninstall -y --no-cache-dir bitsandbytes && \
	#git clone https://git.ecker.tech/mrq/bitsandbytes-rocm.git bitsandbytes && \
	#cd bitsandbytes && \
	#make hip ROCM_TARGET=gfx90a && \
	#python3 -m pip install --no-cache-dir .

	# Clean up
	rm -rf  /{{ REQUIREMENTS_FOLDER }}/

%labels
    Author gianluca.mittone@unito.it
    Version v0.0.2

%help
   HPC-ready container for the xFFL experiments
   Base image for nvidia-based container: nvcr.io/nvidia/pytorch:24.04-py3
   Base image for rocm-based container: rocm/pytorch:rocm5.7_ubuntu22.04_py3.10_pytorch_2.0.1
